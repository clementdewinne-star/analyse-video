<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Analyse - Ultimate</title>
    <style>
        /* DESIGN SOMBRE PRO */
        body { font-family: system-ui, -apple-system, sans-serif; background: #1e272e; padding: 20px; color: white; }
        .video-card { background: #2f3640; padding: 20px; margin-bottom: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 1000px; margin: 0 auto; }
        
        /* LECTEUR VID√âO */
        .video-wrapper { position: relative; width: 100%; background: #000; border-radius: 8px; overflow: hidden; user-select: none; border: 2px solid #444; }
        video { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .drawing-active canvas { pointer-events: auto; cursor: crosshair; }

        /* BARRES D'OUTILS */
        .toolbar-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; padding: 10px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        .toolbar-title { width: 100%; text-align: center; font-size: 12px; color: #aaa; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        
        button { cursor: pointer; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; transition: 0.2s; color: white; font-size: 13px; }
        button:hover { transform: translateY(-2px); filter: brightness(120%); }
        button:disabled { background: #555 !important; cursor: not-allowed; transform: none; color: #888; }
        button.active { outline: 2px solid white; transform: scale(1.05); }

        /* COULEURS */
        .bg-green { background: #27ae60; } .bg-red { background: #e74c3c; } .bg-blue { background: #3498db; } 
        .bg-purple { background: #9b59b6; } .bg-orange { background: #e67e22; } .bg-grey { background: #7f8c8d; } .bg-indigo { background: #4834d4; }

        .tagging-zone { background: #353b48; padding: 15px; border-radius: 8px; text-align: center; margin-top: 15px; }
        .input-time { width: 40px; text-align: center; border-radius: 4px; border: none; padding: 5px; background: #2f3640; color: white; }

        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #353b48; border-left: 4px solid #3498db; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>
    <h1 style="text-align: center;">‚öΩÔ∏è Studio Ultimate</h1>
    {% for video in videos %}
    <div class="video-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">{{ video.titre }}</h2>
            <div>
                <button class="bg-purple" onclick="analyserClipEntier('{{ video.id }}', this)">üß† Coach Tactique (Word)</button>
                <button class="bg-indigo" onclick="lancerSpotlight('{{ video.id }}', this)">üî¶ Spotlight (Vid√©o)</button>
            </div>
        </div>

        <div class="video-wrapper" id="wrapper-{{ video.id }}">
            <video id="vid-{{ video.id }}" playsinline preload="auto" onclick="clickVideo('{{ video.id }}')">
                <source src="{{ video.fichier_video.url }}" type="video/mp4">
            </video>
            <canvas id="canvas-{{ video.id }}"></canvas>
        </div>

        <div class="toolbar-group">
            <div class="toolbar-title">Outils Graphiques</div>
            <button class="bg-green" onclick="togglePlay('{{ video.id }}')">‚èØ Play</button>
            <button class="bg-red tool-btn" onclick="setTool('{{ video.id }}', 'pencil', this)">‚úèÔ∏è Crayon</button>
            <button class="bg-orange tool-btn" onclick="setTool('{{ video.id }}', 'zone', this)">‚ñ± Zone 3D</button>
            <button class="bg-orange tool-btn" onclick="setTool('{{ video.id }}', 'cone', this)">‚ñº C√¥ne</button>
            <button class="bg-grey" onclick="clearDraw('{{ video.id }}')">üóë Effacer</button>
        </div>

        <div class="tagging-zone">
            <p style="margin:0 0 10px 0; color:#aaa;">‚ö°Ô∏è S√©quen√ßage Rapide</p>
            <button class="bg-blue" onclick="tagAuto('{{ video.id }}', 'BUT ‚öΩÔ∏è')">BUT ‚öΩÔ∏è</button>
            <button class="bg-blue" onclick="tagAuto('{{ video.id }}', 'TIR ü•Ö')">TIR ü•Ö</button>
            <button class="bg-blue" onclick="tagAuto('{{ video.id }}', 'FAUTE ‚ö†Ô∏è')">FAUTE ‚ö†Ô∏è</button>
        </div>

        <h3>üìã S√©quences</h3>
        <ul>
            {% for seq in video.sequences.all %}
            <li>
                <span><strong>{{ seq.label }}</strong> ({{ seq.temps_debut }}s)</span>
                <div>
                    <button class="bg-grey" onclick="jumpTo('{{ video.id }}', {{ seq.temps_debut }})">‚ñ∂</button>
                    <a href="/download/{{ seq.id }}/" target="_blank"><button class="bg-blue">‚¨áÔ∏è</button></a>
                    <button class="bg-purple" onclick="analyserSequence('{{ seq.id }}', this)">üß†</button>
                </div>
            </li>
            {% empty %}<li style="color: #888;">Aucune s√©quence.</li>{% endfor %}
        </ul>
    </div>
    {% endfor %}

    <script>
        let currentTool = null, points3D = [], isDrawing = false;

        // --- IA GEMINI (WORD) ---
        function analyserClipEntier(id, btn) {
            const t = btn.innerText; btn.innerText="‚è≥ Word..."; btn.disabled=true; btn.style.background="#555";
            fetch('/ai/video/'+id+'/').then(r=>r.json()).then(d=>{
                btn.innerText=t; btn.disabled=false; btn.style.background="#9b59b6";
                if(d.status==='ok'){ window.location.href=d.url_word; alert("üìÑ Rapport t√©l√©charg√© !"); }
                else alert(d.message);
            }).catch(()=>{alert("Erreur r√©seau"); btn.innerText=t; btn.disabled=false;});
        }
        function analyserSequence(seqId, btn) {
            const t = btn.innerText; btn.innerText="‚è≥"; btn.disabled=true;
            fetch('/ai/sequence/'+seqId+'/').then(r=>r.json()).then(d=>{
                btn.innerText=t; btn.disabled=false;
                if(d.status==='ok') window.location.href=d.url_word; else alert(d.message);
            });
        }

        // --- IA YOLO (SPOTLIGHT) ---
        function lancerSpotlight(id, btn) {
            const t = btn.innerText; btn.innerText="üî¶ Calcul..."; btn.disabled=true; btn.style.background="#555";
            fetch('/ai/spotlight/'+id+'/').then(r=>{if(r.ok)return r.blob();throw new Error('Erreur');})
            .then(blob=>{
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a'); a.href=url; a.download='Spotlight.mp4'; a.click();
                btn.innerText=t; btn.disabled=false; btn.style.background="#4834d4";
            }).catch(e=>{ alert("Erreur Spotlight : " + e); btn.innerText=t; btn.disabled=false; });
        }

        // --- DESSIN 3D ---
        function setTool(id, name, btn) {
            document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
            if(currentTool===name){currentTool=null; toggleCanvas(id,false); return;}
            currentTool=name; points3D=[]; btn.classList.add('active'); toggleCanvas(id,true);
            if(name==='zone') alert("Cliquez 4 points au sol.");
            if(name==='cone') alert("1: Joueur, 2: Gauche, 3: Droite");
        }
        function toggleCanvas(id,on){
            const w=document.getElementById('wrapper-'+id), v=document.getElementById('vid-'+id), c=document.getElementById('canvas-'+id);
            if(on){ w.classList.add('drawing-active'); v.pause(); c.width=v.clientWidth; c.height=v.clientHeight; }
            else w.classList.remove('drawing-active');
        }
        document.querySelectorAll('canvas').forEach(c => {
            const ctx=c.getContext('2d');
            c.addEventListener('mousedown', e=>{
                if(!currentTool)return;
                const x=e.offsetX, y=e.offsetY;
                if(currentTool==='pencil'){isDrawing=true; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineWidth=3; ctx.strokeStyle='#e74c3c';}
                if(currentTool==='zone'){
                    points3D.push({x,y}); ctx.fillStyle='yellow'; ctx.fillRect(x-2,y-2,4,4);
                    if(points3D.length===4){
                        ctx.beginPath(); ctx.moveTo(points3D[0].x,points3D[0].y);
                        for(let i=1;i<4;i++) ctx.lineTo(points3D[i].x,points3D[i].y);
                        ctx.closePath(); ctx.fillStyle='rgba(230,126,34,0.4)'; ctx.fill(); ctx.stroke(); points3D=[];
                    }
                }
                if(currentTool==='cone'){
                    points3D.push({x,y}); ctx.fillStyle='cyan'; ctx.fillRect(x-2,y-2,4,4);
                    if(points3D.length===3){
                        ctx.beginPath(); ctx.moveTo(points3D[0].x,points3D[0].y);
                        ctx.lineTo(points3D[1].x,points3D[1].y); ctx.lineTo(points3D[2].x,points3D[2].y);
                        ctx.closePath(); 
                        let g=ctx.createLinearGradient(points3D[0].x,points3D[0].y,points3D[1].x,points3D[1].y);
                        g.addColorStop(0,"rgba(255,255,255,0.1)"); g.addColorStop(1,"rgba(255,255,255,0.4)");
                        ctx.fillStyle=g; ctx.fill(); points3D=[];
                    }
                }
            });
            c.addEventListener('mousemove', e=>{if(isDrawing && currentTool==='pencil'){ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke();}});
            c.addEventListener('mouseup', ()=>isDrawing=false);
        });
        
        // --- UTILITAIRES ---
        function togglePlay(id){const v=document.getElementById('vid-'+id); if(v.paused)v.play(); else v.pause();}
        function clickVideo(id){if(!currentTool)togglePlay(id);}
        function clearDraw(id){const c=document.getElementById('canvas-'+id); c.getContext('2d').clearRect(0,0,c.width,c.height);}
        function jumpTo(id,t){const v=document.getElementById('vid-'+id); v.currentTime=t; v.play();}
        function tagAuto(id,l){fetch('/api/tag/',{method:'POST',body:JSON.stringify({mode:'auto',video_id:id,label:l,temps:document.getElementById('vid-'+id).currentTime})}).then(()=>location.reload());}
    </script>
</body>
</html>
