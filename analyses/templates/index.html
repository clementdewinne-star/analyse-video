<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Analyse - Pro</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #1e272e; padding: 20px; color: white; }
        .video-card { background: #2f3640; padding: 20px; margin-bottom: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-width: 1000px; margin: 0 auto; }
        .video-wrapper { position: relative; width: 100%; background: #000; border-radius: 8px; overflow: hidden; border: 2px solid #444; }
        video { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .drawing-active canvas { pointer-events: auto; cursor: crosshair; }
        .toolbar-group { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; padding: 10px; border-bottom: 1px solid #444; margin-bottom: 10px; }
        button { cursor: pointer; border: none; padding: 8px 15px; border-radius: 4px; font-weight: bold; transition: 0.2s; color: white; font-size: 13px; }
        .btn-green { background: #27ae60; } .btn-red { background: #e74c3c; } .btn-blue { background: #3498db; margin: 5px; } 
        .btn-purple { background: #9b59b6; } .btn-orange { background: #e67e22; } .btn-grey { background: #7f8c8d; } .btn-indigo { background: #4834d4; }
        .tagging-zone { background: #353b48; padding: 15px; border-radius: 8px; text-align: center; margin-top: 15px; }
        .input-time { width: 40px; text-align: center; border-radius: 4px; border: none; padding: 5px; background: #2f3640; color: white; }
        ul { list-style: none; padding: 0; margin-top: 20px; }
        li { background: #353b48; border-left: 4px solid #3498db; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }

        /* --- MODAL (POP-UP) --- */
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center;
        }
        .modal-content { background: #2f3640; padding: 20px; border-radius: 12px; max-width: 90%; width: 800px; text-align: center; }
        .close-btn { float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa; }
        .close-btn:hover { color: white; }
    </style>
</head>
<body>
    
    <div id="videoModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeModal()">&times;</span>
            <h2 id="modalTitle">Analyse Vid√©o</h2>
            <video id="modalVideo" controls style="width: 100%; border-radius: 8px;"></video>
            <br><br>
            <a id="dlBtn" href="#" target="_blank"><button class="btn-blue">‚¨áÔ∏è T√©l√©charger ce fichier</button></a>
        </div>
    </div>

    <h1 style="text-align: center;">‚öΩÔ∏è Studio Ultimate</h1>

    {% for video in videos %}
    <div class="video-card">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <h2 style="margin:0;">{{ video.titre }}</h2>
            <div>
                <button class="btn-purple" onclick="analyserClipEntier('{{ video.id }}', this)">üß† Coach (Word)</button>
                <button class="btn-indigo" onclick="lancerSpotlight('{{ video.id }}', this)">üî¶ Spotlight (Replay)</button>
            </div>
        </div>

        <div class="video-wrapper" id="wrapper-{{ video.id }}">
            <video id="vid-{{ video.id }}" playsinline preload="auto" onclick="clickVideo('{{ video.id }}')">
                <source src="{{ video.fichier_video.url }}" type="video/mp4">
            </video>
            <canvas id="canvas-{{ video.id }}"></canvas>
        </div>

        <div class="toolbar-group">
            <button class="btn-green" onclick="togglePlay('{{ video.id }}')">‚èØ Play</button>
            <button class="btn-red tool-btn" onclick="setTool('{{ video.id }}', 'pencil', this)">‚úèÔ∏è Dessin</button>
            <button class="btn-orange tool-btn" onclick="setTool('{{ video.id }}', 'zone', this)">‚ñ± Zone 3D</button>
            <button class="btn-orange tool-btn" onclick="setTool('{{ video.id }}', 'cone', this)">‚ñº C√¥ne</button>
            <button class="btn-grey" onclick="clearDraw('{{ video.id }}')">üóë Effacer</button>
        </div>

        <div class="tagging-zone">
            <p style="margin:0 0 10px 0; color:#aaa;">‚ö°Ô∏è S√©quen√ßage Rapide</p>
            <button class="btn-blue" onclick="tagAuto('{{ video.id }}', 'BUT ‚öΩÔ∏è')">BUT</button>
            <button class="btn-blue" onclick="tagAuto('{{ video.id }}', 'TIR ü•Ö')">TIR</button>
            <button class="btn-blue" onclick="tagAuto('{{ video.id }}', 'FAUTE ‚ö†Ô∏è')">FAUTE</button>
        </div>

        <h3>üìã S√©quences</h3>
        <ul>
            {% for seq in video.sequences.all %}
            <li>
                <span><strong>{{ seq.label }}</strong> ({{ seq.temps_debut }}s)</span>
                <div>
                    <button class="btn-grey" style="font-size:11px;" onclick="jumpTo('{{ video.id }}', {{ seq.temps_debut }})">‚ñ∂ Voir</button>
                    <a href="/download/{{ seq.id }}/" target="_blank"><button class="btn-blue" style="font-size:11px;">‚¨áÔ∏è MP4</button></a>
                    <button class="btn-purple" style="font-size:11px;" onclick="analyserSequence('{{ seq.id }}', this)">üß† IA</button>
                </div>
            </li>
            {% empty %}<li style="color: #888;">Aucune s√©quence.</li>{% endfor %}
        </ul>
    </div>
    {% endfor %}

    <script>
        // --- LOGIQUE MODAL & SPOTLIGHT ---
        function lancerSpotlight(id, btn) {
            const txt = btn.innerText; btn.innerText="üî¶ Calcul en cours..."; btn.disabled=true; btn.style.background="#555";
            
            fetch('/ai/spotlight/'+id+'/')
            .then(r => r.json())
            .then(data => {
                btn.innerText = txt; btn.disabled = false; btn.style.background="#4834d4";
                if(data.status === 'ok') {
                    // On ouvre le modal avec la vid√©o
                    openModal(data.video_url, "Analyse Spotlight");
                } else {
                    alert("Erreur : " + data.message);
                }
            })
            .catch(e => { alert("Erreur r√©seau"); btn.innerText=txt; btn.disabled=false; });
        }

        function openModal(url, title) {
            const modal = document.getElementById('videoModal');
            const vid = document.getElementById('modalVideo');
            const dl = document.getElementById('dlBtn');
            
            document.getElementById('modalTitle').innerText = title;
            vid.src = url;
            dl.href = url;
            
            modal.style.display = "flex";
            vid.play();
        }

        function closeModal() {
            const modal = document.getElementById('videoModal');
            const vid = document.getElementById('modalVideo');
            vid.pause();
            vid.src = "";
            modal.style.display = "none";
        }

        // --- RESTE DU CODE (DESSIN, ETC.) ---
        let currentTool = null, points3D = [], isDrawing = false;
        function analyserClipEntier(id, btn) {
            const t = btn.innerText; btn.innerText="Word..."; btn.disabled=true; btn.style.background="#555";
            fetch('/ai/video/'+id+'/').then(r=>r.json()).then(d=>{
                btn.innerText=t; btn.disabled=false; btn.style.background="#9b59b6";
                if(d.status==='ok'){ window.location.href=d.url_word; alert("Rapport t√©l√©charg√© !"); }
            });
        }
        function analyserSequence(seqId, btn) {
            const t = btn.innerText; btn.innerText="Word..."; btn.disabled=true;
            fetch('/ai/sequence/'+seqId+'/').then(r=>r.json()).then(d=>{
                btn.innerText=t; btn.disabled=false; if(d.status==='ok') window.location.href=d.url_word;
            });
        }
        function setTool(id, name, btn) {
            document.querySelectorAll('.tool-btn').forEach(b=>b.classList.remove('active'));
            if(currentTool===name){currentTool=null; toggleCanvas(id,false); return;}
            currentTool=name; points3D=[]; btn.classList.add('active'); toggleCanvas(id,true);
        }
        function toggleCanvas(id,on){
            const w=document.getElementById('wrapper-'+id), v=document.getElementById('vid-'+id), c=document.getElementById('canvas-'+id);
            if(on){ w.classList.add('drawing-active'); v.pause(); c.width=v.clientWidth; c.height=v.clientHeight; } else { w.classList.remove('drawing-active'); }
        }
        document.querySelectorAll('canvas').forEach(c => {
            const ctx=c.getContext('2d');
            c.addEventListener('mousedown', e=>{
                if(!currentTool)return; const x=e.offsetX, y=e.offsetY;
                if(currentTool==='pencil'){isDrawing=true; ctx.beginPath(); ctx.moveTo(x,y); ctx.lineWidth=3; ctx.strokeStyle='#e74c3c';}
                if(currentTool==='zone'){ points3D.push({x,y}); ctx.fillStyle='yellow'; ctx.fillRect(x-2,y-2,4,4); if(points3D.length===4){drawZone3D(ctx,points3D); points3D=[];}}
                if(currentTool==='cone'){ points3D.push({x,y}); ctx.fillStyle='cyan'; ctx.fillRect(x-2,y-2,4,4); if(points3D.length===3){drawCone3D(ctx,points3D); points3D=[];}}
            });
            c.addEventListener('mousemove', e=>{if(isDrawing && currentTool==='pencil'){ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke();}});
            c.addEventListener('mouseup', ()=>isDrawing=false);
        });
        function drawZone3D(ctx, p) { ctx.beginPath(); ctx.moveTo(p[0].x,p[0].y); for(let i=1;i<4;i++)ctx.lineTo(p[i].x,p[i].y); ctx.closePath(); ctx.fillStyle='rgba(230,126,34,0.4)'; ctx.fill(); ctx.stroke(); }
        function drawCone3D(ctx, p) { ctx.beginPath(); ctx.moveTo(p[0].x,p[0].y); ctx.lineTo(p[1].x,p[1].y); ctx.lineTo(p[2].x,p[2].y); ctx.closePath(); ctx.fillStyle='rgba(255,255,255,0.3)'; ctx.fill(); }
        function togglePlay(id){const v=document.getElementById('vid-'+id); if(v.paused)v.play(); else v.pause();}
        function clickVideo(id){if(!currentTool)togglePlay(id);}
        function clearDraw(id){const c=document.getElementById('canvas-'+id); c.getContext('2d').clearRect(0,0,c.width,c.height);}
        function jumpTo(id,t){const v=document.getElementById('vid-'+id); v.currentTime=t; v.play();}
        function tagAuto(id,l){fetch('/api/tag/',{method:'POST',body:JSON.stringify({mode:'auto',video_id:id,label:l,temps:document.getElementById('vid-'+id).currentTime, lag:5, lead:5})}).then(()=>location.reload());}
    </script>
</body>
</html>

