<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Analyse - Ultimate</title>
    <style>
        body { font-family: system-ui, sans-serif; background: #f0f2f5; padding: 20px; color: #333; }
        .video-card { background: white; padding: 20px; margin-bottom: 40px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); max-width: 900px; margin: 0 auto; }
        .video-wrapper { position: relative; width: 100%; background: #000; border-radius: 8px; overflow: hidden; user-select: none; }
        video { width: 100%; display: block; }
        canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .drawing-active canvas { pointer-events: auto; cursor: crosshair; border: 4px solid #ff4757; }
        .toolbar { margin-top: 15px; padding: 15px; background: #ecf0f1; border-radius: 8px; display: flex; gap: 10px; justify-content: center; }
        button { cursor: pointer; border: none; padding: 10px 15px; border-radius: 6px; font-weight: bold; transition: 0.2s; }
        button:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn-green { background: #27ae60; color: white; }
        .btn-red { background: #e74c3c; color: white; }
        .btn-grey { background: #95a5a6; color: white; }
        .btn-blue { background: #2980b9; color: white; margin: 5px; }
        .btn-dark { background: #2c3e50; color: white; }
        .btn-ia { background: #8e44ad; color: white; border: 2px solid #9b59b6; margin-left: 5px; font-size: 11px; }
        .tagging-zone { margin-top: 20px; padding: 20px; background: #e3f2fd; border-radius: 8px; text-align: center; border: 2px dashed #90caf9; }
        .input-time { width: 40px; text-align: center; border-radius: 4px; border: 1px solid #ccc; }
        .filter-bar { margin-top: 20px; padding: 10px; border-bottom: 2px solid #eee; display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { background: white; border: 1px solid #ccc; padding: 5px 15px; border-radius: 20px; font-size: 13px; cursor: pointer; }
        .filter-btn.active { background: #2c3e50; color: white; }
        ul { list-style: none; padding: 0; margin-top: 10px; }
        li { background: #fff; border-left: 5px solid #3498db; padding: 12px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    </style>
</head>
<body>
    <h1 style="text-align: center;">‚öΩÔ∏è Studio Analyse Pro</h1>
    {% for video in videos %}
    <div class="video-card">
        <h2>{{ video.titre }}</h2>
        <div class="video-wrapper" id="wrapper-{{ video.id }}">
            <video id="vid-{{ video.id }}" playsinline preload="auto" onclick="clickVideo('{{ video.id }}')">
                <source src="{{ video.fichier_video.url }}" type="video/mp4">
            </video>
            <canvas id="canvas-{{ video.id }}"></canvas>
        </div>
        <div class="toolbar">
            <button class="btn-green" onclick="togglePlay('{{ video.id }}')">‚èØ Play/Pause</button>
            <button class="btn-red" onclick="toggleDrawMode('{{ video.id }}')">‚úèÔ∏è Dessiner</button>
            <button class="btn-grey" onclick="clearDraw('{{ video.id }}')">üóë Effacer</button>
            <button class="btn-ia" onclick="analyserClipEntier('{{ video.id }}', this)">üß† Analyser ce clip</button>
        </div>
        <div class="tagging-zone">
            <div style="margin-bottom: 15px;">
                <p>‚ö°Ô∏è <strong>Mode Rapide</strong> : <input type="number" id="lag-time" class="input-time" value="5">s avant / <input type="number" id="lead-time" class="input-time" value="5">s apr√®s</p>
                <button class="btn-blue" onclick="tagAuto('{{ video.id }}', 'BUT ‚öΩÔ∏è')">BUT ‚öΩÔ∏è</button>
                <button class="btn-blue" onclick="tagAuto('{{ video.id }}', 'TIR ü•Ö')">TIR ü•Ö</button>
                <button class="btn-blue" onclick="tagAuto('{{ video.id }}', 'FAUTE ‚ö†Ô∏è')">FAUTE ‚ö†Ô∏è</button>
            </div>
            <div>
                <button id="btn-in" class="btn-dark" onclick="setIn('{{ video.id }}')">üö© IN</button>
                <span id="timer-display" style="font-weight: bold; margin: 0 15px;">En attente...</span>
                <button id="btn-out" class="btn-dark" onclick="setOut('{{ video.id }}')" disabled>üèÅ OUT</button>
            </div>
        </div>
        <div class="filter-bar" id="filter-container-{{ video.id }}">
            <button class="filter-btn active" onclick="filterList('all', this, '{{ video.id }}')">Tout</button>
        </div>
        <ul id="list-{{ video.id }}">
            {% for seq in video.sequences.all %}
            <li class="sequence-item" data-label="{{ seq.label }}">
                <span><strong>{{ seq.label }}</strong> ({{ seq.temps_debut }}s - {{ seq.temps_fin }}s)</span>
                <div>
                    <button class="btn-grey" style="font-size: 12px;" onclick="jumpTo('{{ video.id }}', {{ seq.temps_debut }})">‚ñ∂ Voir</button>
                    <a href="/download/{{ seq.id }}/" target="_blank"><button class="btn-ia" style="font-size: 12px;">‚¨áÔ∏è MP4</button></a>
                    <button class="btn-ia" style="font-size: 12px;" onclick="analyserSequence('{{ seq.id }}', this)">üß† IA</button>
                </div>
            </li>
            {% empty %}
            <li style="color: #999;">Aucune s√©quence.</li>
            {% endfor %}
        </ul>
    </div>
    {% endfor %}

    <script>
        // --- LOGIQUE IA + WORD ---
        function analyserClipEntier(videoId, btn) {
            const txt = btn.innerText; btn.innerText = "üß† R√©daction Word..."; btn.disabled = true; btn.style.background = "#7f8c8d";
            fetch('/ai/video/' + videoId + '/').then(r=>r.json()).then(d=>{
                btn.innerText = txt; btn.disabled = false; btn.style.background = "#8e44ad";
                if(d.status==='ok') { window.location.href = d.url_word; alert("üìÑ Rapport Word t√©l√©charg√© !\n\n" + d.rapport.substring(0, 200) + "..."); }
                else alert("Erreur: "+d.message);
            }).catch(()=>{alert("Erreur r√©seau"); btn.innerText=txt; btn.disabled=false;});
        }

        function analyserSequence(seqId, btn) {
            const txt = btn.innerText; btn.innerText = "‚è≥ Word..."; btn.disabled = true;
            fetch('/ai/sequence/' + seqId + '/').then(r=>r.json()).then(d=>{
                btn.innerText = txt; btn.disabled = false;
                if(d.status==='ok') { window.location.href = d.url_word; }
                else alert("Erreur: "+d.message);
            }).catch(()=>{alert("Erreur"); btn.innerText=txt; btn.disabled=false;});
        }

        // --- FONCTIONS EXISTANTES ---
        let isDrawing = false, startTime = null;
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('ul[id^="list-"]').forEach(list => {
                const vidId = list.id.split('-')[1];
                const container = document.getElementById('filter-container-' + vidId);
                const labels = new Set();
                list.querySelectorAll('.sequence-item').forEach(i => labels.add(i.getAttribute('data-label')));
                labels.forEach(l => {
                    const btn = document.createElement('button'); btn.className = 'filter-btn'; btn.innerText = l;
                    btn.onclick = function() { filterList(l, this, vidId); };
                    container.appendChild(btn);
                });
            });
        });
        function filterList(txt, btn, id) {
            document.getElementById('filter-container-'+id).querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            document.getElementById('list-'+id).querySelectorAll('.sequence-item').forEach(i => {
                i.style.display = (txt === 'all' || i.getAttribute('data-label') === txt) ? 'flex' : 'none';
            });
        }
        function togglePlay(id) { const v = document.getElementById('vid-' + id); if(v.paused) v.play(); else v.pause(); }
        function clickVideo(id) { if(!isDrawing) togglePlay(id); }
        function jumpTo(id, t) { const v = document.getElementById('vid-' + id); v.currentTime = t; v.play(); }
        function toggleDrawMode(id) {
            isDrawing = !isDrawing;
            const w = document.getElementById('wrapper-' + id); const v = document.getElementById('vid-' + id); const c = document.getElementById('canvas-' + id);
            if(isDrawing) { w.classList.add('drawing-active'); v.pause(); c.width=v.clientWidth; c.height=v.clientHeight; } else { w.classList.remove('drawing-active'); }
        }
        function clearDraw(id) { const c = document.getElementById('canvas-' + id); c.getContext('2d').clearRect(0,0,c.width,c.height); }
        function tagAuto(id, label) {
            fetch('/api/tag/', { method: 'POST', body: JSON.stringify({ mode: 'auto', video_id: id, label: label, temps: document.getElementById('vid-' + id).currentTime, lag: document.getElementById('lag-time').value, lead: document.getElementById('lead-time').value })})
            .then(() => location.reload());
        }
        function setIn(id) {
            startTime = document.getElementById('vid-' + id).currentTime;
            document.getElementById('btn-in').style.background = '#27ae60';
            document.getElementById('btn-in').innerText = "IN : " + startTime.toFixed(1);
            document.getElementById('btn-out').disabled = false;
            document.getElementById('btn-out').style.background = '#c0392b';
        }
        function setOut(id) {
            if(startTime === null) return;
            const label = prompt("Nom ?", "Action");
            if(label) fetch('/api/tag/', { method: 'POST', body: JSON.stringify({ mode: 'manual', video_id: id, label: label, start_time: startTime, end_time: document.getElementById('vid-' + id).currentTime })})
            .then(() => location.reload());
        }
        document.querySelectorAll('canvas').forEach(c => {
            const ctx = c.getContext('2d'); let p = false;
            c.addEventListener('mousedown', e => { if(isDrawing){ p=true; ctx.beginPath(); ctx.moveTo(e.offsetX, e.offsetY); ctx.lineWidth=4; ctx.strokeStyle='#ff4757'; }});
            c.addEventListener('mousemove', e => { if(p){ ctx.lineTo(e.offsetX, e.offsetY); ctx.stroke(); }});
            c.addEventListener('mouseup', () => p=false);
        });
    </script>
</body>
</html>

